name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # è¨­å®š Docker Image åç¨± (æŒ‡å‘ GitHub Container Registry)
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      # ğŸ‘‡ [ä¿®æ­£ 1] æ–°å¢é€™ä¸€æ­¥ï¼šå•Ÿç”¨ Docker Buildx
      # é€™èƒ½è§£æ±º "Cache export is not supported" çš„éŒ¯èª¤
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ‘‡ [ä¿®æ­£ 2] å¼·åˆ¶ä½¿ç”¨å…¨å°å¯«åç¨±
      # åŸæœ¬çš„ ${{ env.IMAGE_NAME }} å«æœ‰å¤§å¯«ï¼Œé€™è£¡ç›´æ¥å¯«æ­»å°å¯«åç¨±æœ€ä¿éšª
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # è«‹ç¢ºèªé€™è£¡æ˜¯å…¨å°å¯«
          tags: ghcr.io/onlyatuna/shoppingpage:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # ğŸ‘‡ [ä¿®æ­£ 3] éƒ¨ç½²è…³æœ¬ä¸­çš„ Image åç¨±ä¹Ÿè¦æ”¹æˆå°å¯«
          script: |
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # æ‹‰å–å°å¯«åç¨±
            docker pull ghcr.io/onlyatuna/shoppingpage:latest
            
            mkdir -p ~/shop-app
            cd ~/shop-app || exit 1
            
            # ... (.env ç”¢ç”Ÿçš„éƒ¨åˆ†ä¿æŒä¸è®Š) ...
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "LINE_PAY_CHANNEL_ID=${{ secrets.LINE_PAY_CHANNEL_ID }}" >> .env
            echo "LINE_PAY_CHANNEL_SECRET=${{ secrets.LINE_PAY_CHANNEL_SECRET }}" >> .env
            echo "SMTP_HOST=${{ secrets.SMTP_HOST }}" >> .env
            echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
            echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
            echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env
            echo "NODE_ENV=production" >> .env

            docker compose down
            docker compose up -d
            docker image prune -f
  # --- Job 2: å»ºç½®ä¸¦æ¨é€ Docker Image ---
  build-and-push:
    needs: check-code
    if: github.event_name == 'push' # åªåœ¨ merge åˆ° main æ™‚åŸ·è¡Œ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # å»ºç½® Backend Image (åŒ…å« Frontend buildï¼Œå› ç‚ºæ˜¯ Monorepo)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          # ä½¿ç”¨ Cache åŠ é€Ÿå»ºç½®
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # --- Job 3: éƒ¨ç½²åˆ° EC2 ---
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. ç™»å…¥ GHCR (è®“ EC2 æœ‰æ¬Šé™æ‹‰ Image)
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 2. æ‹‰å–æœ€æ–° Image
            docker pull ghcr.io/${{ env.IMAGE_NAME }}:latest
            
            # 3. ç¢ºä¿å°ˆæ¡ˆç›®éŒ„å­˜åœ¨
            mkdir -p ~/shop-app
            cd ~/shop-app
            
            # 4. å»ºç«‹/æ›´æ–° .env æª”æ¡ˆ (å¾ GitHub Secrets æ³¨å…¥)
            echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" > .env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
            echo "LINE_PAY_CHANNEL_ID=${{ secrets.LINE_PAY_CHANNEL_ID }}" >> .env
            echo "LINE_PAY_CHANNEL_SECRET=${{ secrets.LINE_PAY_CHANNEL_SECRET }}" >> .env
            echo "SMTP_USER=${{ secrets.SMTP_USER }}" >> .env
            echo "SMTP_PASS=${{ secrets.SMTP_PASS }}" >> .env
            echo "NODE_ENV=production" >> .env
            # ...åŠ å…¥å…¶ä»–éœ€è¦çš„è®Šæ•¸
            
            # 5. é‡å•Ÿæœå‹™
            # æ³¨æ„ï¼šé€™è£¡å‡è¨­æ‚¨çš„ docker-compose.yml å·²ç¶“åœ¨ä¼ºæœå™¨ä¸Šï¼Œæˆ–è€…æ‚¨å¯ä»¥åœ¨é€™è£¡ç”¨ echo å¯«å…¥å®ƒ
            docker compose down
            docker compose up -d
            
            # 6. åŸ·è¡Œ Prisma Migration (ç¢ºä¿ DB çµæ§‹æœ€æ–°)
            docker compose exec -T backend npx prisma migrate deploy
            
            # 7. æ¸…ç†èˆŠ Image (é‡‹æ”¾ç©ºé–“)
            docker image prune -f