// apps/backend/prisma/schema.prisma

// 定義資料庫連線
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 產生 TypeScript Client
generator client {
  provider      = "prisma-client-js"
  // [修正] 加入 debian-openssl-3.0.x 以支援 Node 20 容器環境
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

// --------------------------------------
// Enums (列舉): 統一狀態管理
// --------------------------------------

enum Role {
  USER
  ADMIN
  DEVELOPER
}

enum OrderStatus {
  PENDING // 待付款
  AUTHORIZED // 已授權 (錢被圈存，尚未扣款)
  PAID // 已付款 (錢已扣除)
  SHIPPED // 已出貨
  COMPLETED // 已完成
  CANCELLED // 已取消 (未付款前取消，或 Void)
  REFUNDED // [新增] 已全額退款
  PARTIALLY_REFUNDED // [新增] 已部分退款
}

// --------------------------------------
// Models (資料表定義)
// --------------------------------------

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String?
  role     Role    @default(USER)

  // 驗證相關
  isVerified                 Boolean   @default(false)
  verificationToken          String?   @unique
  verificationTokenExpiresAt DateTime?

  // 重置密碼相關
  resetPasswordToken          String?   @unique
  resetPasswordTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cart         Cart?
  orders       Order[]
  addresses    Address[]
  customStyles CustomStyle[]

  @@map("users")
}

model Address {
  id        Int     @id @default(autoincrement())
  recipient String
  phone     String
  city      String
  address   String
  isDefault Boolean @default(false)

  userId Int
  user   User @relation(fields: [userId], references: [id])

  @@map("addresses")
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String
  slug     String    @unique
  products Product[]
  deletedAt DateTime?

  @@map("categories")
}

model Product {
  id          Int     @id @default(autoincrement())
  name        String
  slug        String  @unique
  description String? @db.Text

  price Decimal @db.Decimal(10, 2)
  salePrice Decimal? @db.Decimal(10, 2) // [New] 特價價格
  isOnSale Boolean @default(false)      // [New] 是否特價
  stock Int     @default(0)

  images Json?
  
  // [新增] 規格選項定義 (例如: [{id: "opt1", name: "顏色", values: ["紅", "藍"]}])
  options Json?

  // [新增] 規格變體組合 (例如: [{id: "v1", price: 100, stock: 10, combination: {opt1: "紅"}}])
  variants Json?



  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id], map: "products_categoryId_custom_fk")

  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([name])
  @@index([categoryId])
  @@map("products")
}

model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id       Int @id @default(autoincrement())
  quantity Int @default(1)

  cartId Int
  cart   Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  variantId String? // [New] Store the variant ID (e.g. "var_123")

  @@unique([cartId, productId, variantId]) // Update unique constraint to include variantId
  @@map("cart_items")
}

model Order {
  id     String @id @default(uuid())
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status      OrderStatus @default(PENDING)
  totalAmount Decimal     @db.Decimal(10, 2)

  shippingInfo Json

  paymentId   String?
  paymentData Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items OrderItem[]

  @@map("orders")
}

model OrderItem {
  id      Int    @id @default(autoincrement())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  price    Decimal @db.Decimal(10, 2)

  @@map("order_items")
}

model CustomStyle {
  id          Int     @id @default(autoincrement())
  key         String  // Unique identifier for the style
  name        String  // Display name (Chinese)
  engName     String? // English name
  desc        String? // Description
  icon        String? // Icon name
  color       String? // Background color
  borderColor String? // Border color
  prompt      String  @db.Text // AI generation prompt
  preview     String? // Preview image URL (optional)

  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, key]) // Ensure unique style key per user
  @@map("custom_styles")
}
