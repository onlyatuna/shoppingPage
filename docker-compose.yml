version: '3.8'

services:
  # ğŸ‘‡ [æ–°å¢] Caddy æœå‹™ (è² è²¬ HTTPS)
  caddy:
    image: caddy:latest
    container_name: shopping-caddy
    restart: always
    ports:
      - "80:80"   # HTTP (è‡ªå‹•è½‰ HTTPS)
      - "443:443" # HTTPS
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile # æ›è¼‰è¨­å®šæª”
      - caddy_data:/data                 # æŒä¹…åŒ–æ†‘è­‰
      - caddy_config:/config
    depends_on:
      - app
  app:
    # 1. [ä¿®æ­£] æ”¹ç”¨ GHCR Image (å…¨å°å¯«)
    # è®“ EC2 ç›´æ¥ä¸‹è¼‰ç·¨è­¯å¥½çš„æª”æ¡ˆï¼Œä¸è¦è‡ªå·± Build
    image: ghcr.io/onlyatuna/shoppingpage:latest
    container_name: shopping-app
    restart: always
    
    # 2. [è¨­å®š] é€£æ¥åŸ 
    # æ‚¨åŸæœ¬å¯« 80:3000ï¼Œå¦‚æœæ‚¨æ²’æœ‰ç”¨ Caddy/Nginxï¼Œé€™æ¨£å¯ä»¥ç›´æ¥ç”¨ IP è¨ªå•
    # å¦‚æœæœ‰ç”¨ Caddyï¼Œå»ºè­°æ”¹å› 3000:3000
    ports:
      - "3000:3000"

    # 3. [ä¿®æ­£] è®€å– CI/CD ç”Ÿæˆçš„ .env æª”æ¡ˆ
    # é€™æ¨£å°±ä¸ç”¨æŠŠå¯†ç¢¼å¯«æ­»åœ¨é€™è£¡ï¼Œè€Œä¸”èƒ½è®€åˆ°æœ€æ–°çš„ GitHub Secrets
    env_file:
      - .env
      
    depends_on:
      - db

    # 4. [ä¿ç•™] è³‡æºé™åˆ¶ (åšå¾—å¥½ï¼é€™èƒ½é˜²æ­¢ç•¶æ©Ÿ)
    deploy:
      resources:
        limits:
          cpus: '0.80'
          memory: 600M

  db:
    image: mysql:8.0
    container_name: shopping-db
    restart: always
    environment:
      # 5. [ä¿®æ­£] å¯†ç¢¼æ”¹ç”¨è®Šæ•¸ (æœƒè‡ªå‹•è®€å– .env ä¸­çš„ DATABASE_PASSWORD)
      # ç‚ºäº†ç›¸å®¹æ‚¨åŸæœ¬çš„ .env ç”Ÿæˆè…³æœ¬ï¼Œæˆ‘å€‘ç¨å¾Œéœ€ç¢ºèª .env æœ‰æ²’æœ‰é€™å€‹è®Šæ•¸
      # å¦‚æœæ²’æœ‰ï¼Œæš«æ™‚å¯«æ­»ä¹Ÿå¯ä»¥ï¼Œä½†å»ºè­°ç”¨è®Šæ•¸
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD:-Qq940628}
      MYSQL_DATABASE: shop_db
    volumes:
      - mysql_data:/var/lib/mysql
      # åŠ å…¥é€™å€‹è¨­å®šä»¥å„ªåŒ– MySQL è¨˜æ†¶é«”ä½¿ç”¨ (å°å°æ©Ÿå™¨å¾ˆé‡è¦)
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=256M

volumes:
  mysql_data:
  caddy_data:   # [æ–°å¢]
  caddy_config: # [æ–°å¢]